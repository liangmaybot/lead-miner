import { mkdirSync, writeFileSync } from 'fs';
import { dirname } from 'path';

function ensureDir(filepath) {
  const dir = dirname(filepath);
  if (dir && dir !== '.') {
    mkdirSync(dir, { recursive: true });
  }
}

function escapeCell(value) {
  if (value === null || value === undefined) return '';
  let text = String(value);
  if (text.includes('"')) {
    text = text.replace(/"/g, '""');
  }
  if (/[",\n]/.test(text)) {
    return `"${text}"`;
  }
  return text;
}

export function createObjectCsvWriter({ path, header }) {
  return {
    async writeRecords(records) {
      ensureDir(path);
      const headerLine = header.map(col => escapeCell(col.title)).join(',');
      const lines = records.map(record => (
        header.map(col => escapeCell(record[col.id])).join(',')
      ));
      const csv = [headerLine, ...lines].join('\n') + '\n';
      writeFileSync(path, csv, 'utf8');
    },
  };
}
